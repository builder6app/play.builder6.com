<!DOCTYPE html>
<html lang="en">
<head>
    {% render 'partials/head.liquid' %}
    <title>Settings: {{ organization.name }} - Builder6</title>
</head>
<body class="bg-black text-white font-sans antialiased selection:bg-blue-500 selection:text-white flex flex-col min-h-screen">

    {% render 'partials/header.liquid', is_editor: false, user: user %}
    {% render 'partials/notifications.liquid' %}

    <main class="flex-1 max-w-4xl mx-auto py-12 px-4 sm:px-6 lg:px-8 w-full" x-data="orgSettings">
        <div class="mb-8">
            <div class="flex items-center gap-4 mb-6">
                <a href="/app" class="p-2 -ml-2 text-gray-400 hover:text-white rounded-lg hover:bg-white/10 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                </a>
                <h1 class="text-3xl font-bold text-white">{{ organization.name }}</h1>
            </div>

            <!-- Tabs -->
            <div class="flex items-center gap-1 border-b border-white/10">
                <a href="/org/{{ organization.slug }}/settings" class="px-4 py-2 text-sm font-medium border-b-2 border-blue-500 text-blue-400">Settings</a>
                <a href="/org/{{ organization.slug }}/members" class="px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-700 transition-all">Members</a>
            </div>
        </div>

        <div class="space-y-8">
            <!-- General Info -->
            <div class="bg-[#1c1c1e] p-8 rounded-2xl border border-white/10 shadow-xl">
                <h2 class="text-xl font-bold text-white mb-6">General Information</h2>
                <form @submit.prevent="updateOrg" class="space-y-6">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-400 uppercase tracking-wider">Organization Name</label>
                            <input type="text" x-model="name" required 
                                class="w-full bg-black/50 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-all">
                        </div>
                        
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-400 uppercase tracking-wider">Slug</label>
                            <input type="text" x-model="slug" required 
                                class="w-full bg-black/50 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-all font-mono">
                        </div>
                    </div>

                    <div class="pt-4 flex justify-end">
                        <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white font-medium rounded-xl transition-all shadow-lg shadow-blue-900/20">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>

            <!-- Danger Zone -->
            <div class="bg-[#1c1c1e] p-8 rounded-2xl border border-red-500/20 shadow-xl relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-red-600 to-orange-600"></div>
                <h2 class="text-xl font-bold text-white mb-2">Danger Zone</h2>
                <p class="text-gray-400 mb-6 text-sm">Irreversible actions for your organization.</p>
                
                <div class="flex items-center justify-between p-4 border border-red-500/10 bg-red-500/5 rounded-xl">
                    <div>
                        <h3 class="font-medium text-red-200">Delete Organization</h3>
                        <p class="text-sm text-red-400/60 mt-1">Permanently remove this organization and all its data.</p>
                    </div>
                    <button @click="deleteOrg" class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white text-sm font-medium rounded-lg transition-colors shadow-lg shadow-red-900/30">
                        Delete Organization
                    </button>
                </div>
                 <div class="flex items-center justify-between p-4 border border-red-500/10 bg-red-500/5 rounded-xl mt-4">
                    <div>
                        <h3 class="font-medium text-red-200">Leave Organization</h3>
                        <p class="text-sm text-red-400/60 mt-1">Revoke your access to this organization.</p>
                    </div>
                    <button @click="leaveOrg" class="px-4 py-2 bg-red-600/20 hover:bg-red-600/30 text-red-200 text-sm font-medium rounded-lg transition-colors border border-red-500/20">
                        Leave Organization
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('orgSettings', () => ({
                orgId: {{ organization.id | json }},
                name: {{ organization.name | json }},
                slug: {{ organization.slug | json }},
                
                async updateOrg() {
                    try {
                        const res = await fetch('/api/auth/organization/update', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                organizationId: this.orgId,
                                data: {
                                    name: this.name,
                                    slug: this.slug
                                }
                            })
                        });
                        
                        if (res.ok) {
                            $notify('Organization updated successfully', 'success');
                            setTimeout(() => {
                                if (this.slug !== {{ organization.slug | json }}) {
                                    window.location.href = `/org/${this.slug}/settings`;
                                } else {
                                    window.location.reload();
                                }
                            }, 1000);
                        } else {
                            const error = await res.json();
                            $notify(error.message || 'Failed to update organization', 'error');
                        }
                    } catch (err) {
                        console.error(err);
                        $notify('An error occurred', 'error');
                    }
                },

                async deleteOrg() {
                    if (!confirm('Are you sure you want to delete this organization? This action cannot be undone.')) return;
                    
                    try {
                        const res = await fetch('/api/auth/organization/delete', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ organizationId: this.orgId })
                        });
                        
                        if (res.ok) {
                            $notify('Organization deleted successfully', 'success');
                            setTimeout(() => {
                                window.location.href = '/app';
                            }, 1000);
                        } else {
                            const error = await res.json();
                            $notify(error.message || 'Failed to delete organization', 'error');
                        }
                    } catch (err) {
                        console.error(err);
                        $notify('An error occurred', 'error');
                    }
                },

                async leaveOrg() {
                    if (!confirm('Are you sure you want to leave this organization?')) return;
                    try {
                        const res = await fetch('/api/auth/organization/leave', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ organizationId: this.orgId })
                        });
                        
                        if (res.ok) {
                            window.location.href = '/org';
                        } else {
                            const err = await res.json();
                            $notify(err.message || 'Failed to leave organization', 'error');
                        }
                    } catch (e) {
                         $notify('An error occurred', 'error');
                    }
                },
            }))
        })
    </script>
</body>
</html>
