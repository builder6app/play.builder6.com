<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ project.name }} - Object Designer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body { height: 100%; margin: 0; overflow: hidden; }
        .code-editor {
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            line-height: 1.5;
        }
    </style>
</head>
<body class="flex flex-col h-screen bg-black text-white font-sans antialiased selection:bg-blue-500 selection:text-white">

    {% render 'partials/header.liquid', is_page_editor: false, is_object_editor: true, project: project, user: user %}

    <!-- Editor Toolbar -->
    <div class="flex items-center justify-between px-6 py-2 border-b border-white/10 bg-[#1c1c1e] z-40">
        <div class="flex items-center gap-2">
             <div class="flex items-center gap-2">
                <a href="/app/{{ project.slug | default: project._id }}" class="text-sm text-gray-400 hover:text-white transition-colors">{{ project.name }}</a>
                <span class="text-gray-600">/</span>
                <div class="flex items-center gap-2">
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    {% if isNew %}
                    <span class="text-sm font-medium text-white">New Object</span>
                    {% else %}
                    <span class="text-sm font-medium text-white">{{ object.label }} ({{ object.name }})</span>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <button onclick="copyToClipboard()" class="text-xs bg-white/5 hover:bg-white/10 text-gray-300 px-3 py-1.5 rounded transition-colors">Copy YAML</button>

            <div class="h-6 w-px bg-white/10 mx-1"></div>

            <button onclick="saveObject()" class="bg-[#007AFF] hover:bg-[#0062cc] text-white px-4 py-1.5 rounded-lg text-sm font-medium transition-all shadow-lg shadow-blue-900/20 hover:shadow-blue-900/40 flex items-center gap-2 transform active:scale-95">
                <span>Save Object</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg>
            </button>
        </div>
    </div>

    <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar / Prompt Area -->
        <div class="w-1/3 border-r border-white/10 flex flex-col bg-[#1c1c1e]">
            <div class="p-6 border-b border-white/10">
                <h2 class="text-xl font-bold mb-2">AI Object Generator</h2>
                <p class="text-sm text-gray-400">Describe the data object you want to build. AI will generate the Steedos Object YAML for you.</p>
            </div>
            
            <div class="p-6 flex-1 flex flex-col space-y-4 overflow-y-auto">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Instructions</label>
                    <textarea id="promptInput" rows="6" 
                        class="w-full bg-black/50 border border-white/10 rounded-xl p-4 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none transition-all"
                        placeholder="e.g., Create a 'Task' object with fields for title, description, due date, priority (High, Medium, Low), and assigned user."></textarea>
                </div>

                <div class="flex items-center justify-end">
                    <button id="generateBtn" onclick="generateSchema()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2.5 rounded-lg font-medium transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        <span>Generate Schema</span>
                    </button>
                </div>

                <div id="statusMessage" class="hidden rounded-lg p-4 text-sm"></div>
            </div>
        </div>

        <!-- Main Content / Code Editor -->
        <div class="flex-1 flex flex-col bg-[#0d0d0d] relative">

            <!-- Toolbar Removed -->

            
            <div class="flex-1 relative">
                <textarea id="resultOutput" 
                    class="absolute inset-0 w-full h-full bg-[#0d0d0d] text-gray-300 p-6 code-editor text-sm focus:outline-none resize-none"
                    spellcheck="false"
                    placeholder="# Describe your object on the left and click 'Generate', or type YAML here...">{{ object.schema }}</textarea>
                
                <!-- Loading Overlay -->
                <div id="loadingOverlay" class="absolute inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-10">
                    <div class="flex flex-col items-center gap-3">
                        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-white"></div>
                        <span class="text-white font-medium">Generating Schema...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const generateBtn = document.getElementById('generateBtn');
        const promptInput = document.getElementById('promptInput');
        const resultOutput = document.getElementById('resultOutput');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const statusMessage = document.getElementById('statusMessage');

        const isNew = {{ isNew | default: false }};
        const objectId = "{{ object._id }}";
        const projectId = "{{ projectId }}";

        async function saveObject() {
            const schema = resultOutput.value.trim();
            if (!schema) {
                alert('Please enter or generate a schema first');
                return;
            }

            // Simple parsing to extract name and label
            const nameMatch = schema.match(/^name:\s*(.+)$/m);
            const labelMatch = schema.match(/^label:\s*(.+)$/m);
            const descriptionMatch = schema.match(/^description:\s*(.+)$/m);

            const data = {
                projectId: projectId,
                schema: schema,
                name: nameMatch ? nameMatch[1].trim() : (isNew ? 'untitled' : '{{ object.name }}'),
                label: labelMatch ? labelMatch[1].trim() : (isNew ? 'Untitled' : '{{ object.label }}'),
                description: descriptionMatch ? descriptionMatch[1].trim() : '',
                icon: 'cube'
            };

            try {
                const url = isNew ? `/app/${projectId}/objects` : `/app/${projectId}/objects/${objectId}`;
                const method = isNew ? 'POST' : 'PUT';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Failed to save');

                const savedObj = await response.json();
                
                showStatus('Object saved successfully!', 'success');
                
                if (isNew) {
                     setTimeout(() => {
                        window.location.href = `/app/${projectId}/objects/${savedObj._id}`;
                    }, 500);
                }
            } catch (error) {
                console.error(error);
                showStatus('Failed to save object.', 'error');
            }
        }

        async function generateSchema() {
            const prompt = promptInput.value.trim();
            if (!prompt) return;

            // UI State: Loading
            generateBtn.disabled = true;
            loadingOverlay.classList.remove('hidden');
            loadingOverlay.classList.add('flex');
            statusMessage.classList.add('hidden');

            try {
                const response = await fetch(`/app/${projectId}/objects/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });

                if (!response.ok) throw new Error('Generation failed');

                const data = await response.json();
                
                // Update specific part of UI
                resultOutput.value = data.params; // 'params' contains the YAML content from backend

                showStatus('Schema generated successfully!', 'success');

            } catch (error) {
                console.error(error);
                showStatus('Failed to generate schema. Please try again.', 'error');
            } finally {
                // UI State: Reset
                generateBtn.disabled = false;
                loadingOverlay.classList.add('hidden');
                loadingOverlay.classList.remove('flex');
            }
        }

        function showStatus(msg, type) {
            statusMessage.textContent = msg;
            statusMessage.classList.remove('hidden', 'bg-green-500/10', 'text-green-400', 'bg-red-500/10', 'text-red-400');
            
            if (type === 'success') {
                statusMessage.classList.add('bg-green-500/10', 'text-green-400');
            } else {
                statusMessage.classList.add('bg-red-500/10', 'text-red-400');
            }
        }

        function copyToClipboard() {
            resultOutput.select();
            document.execCommand('copy');
            // Deselect
            window.getSelection().removeAllRanges();
            
            const originalText = document.querySelector('button[onclick="copyToClipboard()"]').textContent;
            document.querySelector('button[onclick="copyToClipboard()"]').textContent = 'Copied!';
            setTimeout(() => {
                document.querySelector('button[onclick="copyToClipboard()"]').textContent = originalText;
            }, 2000);
        }
        
        // Allow Cmd+Enter to submit
        promptInput.addEventListener('keydown', function(e) {
            if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
                e.preventDefault();
                generateSchema();
            }
        });
    </script>
</body>
</html>
