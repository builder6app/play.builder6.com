<!DOCTYPE html>
<html lang="en">
<head>
    {% render 'partials/head.liquid' %}
    <title>{{ project.name }} - Object Designer</title>
    <style>
        html, body { height: 100%; margin: 0; overflow: hidden; }
        .code-editor {
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            line-height: 1.5;
        }
        
        .bg-grid-pattern {
            background-color: #f5f5f7;
            background-image: 
                linear-gradient(rgba(0,0,0,0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,0.02) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body class="flex flex-col h-screen bg-black text-white font-sans antialiased selection:bg-blue-500 selection:text-white">

    {% render 'partials/notifications.liquid' %}

    <!-- Editor Toolbar -->
    <div class="flex items-center justify-between px-6 py-2 border-b border-white/10 bg-[#1c1c1e] z-40">
        <div class="flex items-center gap-3">
             <a href="/app/{{ project.slug | default: project._id }}" class="flex items-center justify-center w-8 h-8 rounded-lg bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white transition-all border border-white/10 group" title="Back to Project">
                <i class="ri-arrow-left-line text-lg group-hover:-translate-x-0.5 transition-transform"></i>
             </a>
             <div class="flex items-center gap-2">
                <span class="text-sm text-gray-400">{{ project.name }}</span>
                <span class="text-gray-600">/</span>
                <div class="flex items-center gap-2">
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    {% if isNew %}
                    <span class="text-sm font-medium text-white">New Object</span>
                    {% else %}
                    <span class="text-sm font-medium text-white">{{ object.label }} ({{ object.name }})</span>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- View Switcher -->
        <div class="bg-black/20 p-1 rounded-lg flex items-center border border-white/5">
             <button id="viewBtnDesign" class="px-3 py-1 rounded-md text-sm font-medium bg-white/10 text-white shadow-sm transition-all flex items-center gap-1.5 focus:outline-none">
                <svg class="w-4 h-4 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                Design
             </button>
             <button id="viewBtnCode" class="px-3 py-1 rounded-md text-sm font-medium text-gray-400 hover:text-white transition-all flex items-center gap-1.5 focus:outline-none">
                <svg class="w-4 h-4 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                Code
             </button>
        </div>
        
        <div class="flex items-center gap-4">
            <button onclick="copyToClipboard()" class="text-xs bg-white/5 hover:bg-white/10 text-gray-300 px-3 py-1.5 rounded transition-colors">Copy YAML</button>

            <div class="h-6 w-px bg-white/10 mx-1"></div>

            <button onclick="saveObject()" class="bg-[#007AFF] hover:bg-[#0062cc] text-white px-4 py-1.5 rounded-lg text-sm font-medium transition-all shadow-lg shadow-blue-900/20 hover:shadow-blue-900/40 flex items-center gap-2 transform active:scale-95">
                <span>Save Object</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg>
            </button>
        </div>
    </div>

    <div class="flex flex-1 overflow-hidden relative">

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col min-w-0 relative">
             <div class="flex-1 relative flex">
                 <!-- Code Editor View (Hidden by default or toggled) -->
                 <div id="codeView" class="hidden absolute inset-0 z-10 bg-[#1c1c1e] flex flex-col">
                    <div id="editor-container" class="flex-1"></div>
                 </div>

                 <!-- Designer View -->
                 <div id="designView" class="absolute inset-0 z-0 flex flex-row bg-[#F5F5F7]">
                     <!-- Components Toolbox -->
                    <div class="w-64 bg-[#F5F5F7] border-r border-gray-300 flex flex-col z-10 flex-shrink-0 backdrop-blur-xl bg-opacity-80">
                        <div class="px-5 py-4 text-xs font-semibold uppercase tracking-wider text-gray-400">
                            Components
                        </div>
                        <div id="fieldsPalette" class="flex-1 overflow-y-auto px-4 pb-4 space-y-6">
                            
                            <!-- Text & Input -->
                            <div>
                                <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2 px-1">Text & Input</div>
                                <div class="space-y-2">
                                    <div class="palette-item bg-white shadow-sm border border-gray-200/50 hover:border-blue-400 hover:shadow-md hover:-translate-y-0.5 transition-all duration-200 rounded-xl p-3 text-sm text-gray-700 cursor-grab flex items-center gap-3 select-none" data-type="text">
                                        <div class="w-8 h-8 rounded-lg bg-blue-50 text-blue-500 flex items-center justify-center"><i class="ri-text text-lg"></i></div> 
                                        <span class="font-medium">Text</span>
                                    </div>
                                    <div class="palette-item bg-white shadow-sm border border-gray-200/50 hover:border-blue-400 hover:shadow-md hover:-translate-y-0.5 transition-all duration-200 rounded-xl p-3 text-sm text-gray-700 cursor-grab flex items-center gap-3 select-none" data-type="textarea">
                                        <div class="w-8 h-8 rounded-lg bg-blue-50 text-blue-500 flex items-center justify-center"><i class="ri-file-text-line text-lg"></i></div> 
                                        <span class="font-medium">Long Text</span>
                                    </div>
                                    <div class="palette-item bg-white shadow-sm border border-gray-200/50 hover:border-blue-400 hover:shadow-md hover:-translate-y-0.5 transition-all duration-200 rounded-xl p-3 text-sm text-gray-700 cursor-grab flex items-center gap-3 select-none" data-type="html">
                                        <div class="w-8 h-8 rounded-lg bg-blue-50 text-blue-500 flex items-center justify-center"><i class="ri-article-line text-lg"></i></div> 
                                        <span class="font-medium">Rich Text</span>
                                    </div>
                                    <div class="palette-item bg-white shadow-sm border border-gray-200/50 hover:border-blue-400 hover:shadow-md hover:-translate-y-0.5 transition-all duration-200 rounded-xl p-3 text-sm text-gray-700 cursor-grab flex items-center gap-3 select-none" data-type="email">
                                        <div class="w-8 h-8 rounded-lg bg-blue-50 text-blue-500 flex items-center justify-center"><i class="ri-mail-line text-lg"></i></div> 
                                        <span class="font-medium">Email</span>
                                    </div>
                                    <div class="palette-item bg-white shadow-sm border border-gray-200/50 hover:border-blue-400 hover:shadow-md hover:-translate-y-0.5 transition-all duration-200 rounded-xl p-3 text-sm text-gray-700 cursor-grab flex items-center gap-3 select-none" data-type="url">
                                        <div class="w-8 h-8 rounded-lg bg-blue-50 text-blue-500 flex items-center justify-center"><i class="ri-link text-lg"></i></div> 
                                        <span class="font-medium">URL</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Numbers & Currency -->
                            <div>
                                <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2 px-1">Numbers & Currency</div>
                                <div class="space-y-2">
                                    <div class="palette-item bg-white shadow-sm border border-gray-200/50 hover:border-blue-400 hover:shadow-md hover:-translate-y-0.5 transition-all duration-200 rounded-xl p-3 text-sm text-gray-700 cursor-grab flex items-center gap-3 select-none" data-type="number">
                                        <div class="w-8 h-8 rounded-lg bg-green-50 text-green-500 flex items-center justify-center"><i class="ri-hashtag text-lg"></i></div> 
                                        <span class="font-medium">Number</span>
                                    </div>
                                    <div class="palette-item bg-white shadow-sm border border-gray-200/50 hover:border-blue-400 hover:shadow-md hover:-translate-y-0.5 transition-all duration-200 rounded-xl p-3 text-sm text-gray-700 cursor-grab flex items-center gap-3 select-none" data-type="currency">
                                        <div class="w-8 h-8 rounded-lg bg-green-50 text-green-500 flex items-center justify-center"><i class="ri-money-dollar-circle-line text-lg"></i></div> 
                                        <span class="font-medium">Currency</span>
                                    </div>
                                    <div class="palette-item bg-white shadow-sm border border-gray-200/50 hover:border-blue-400 hover:shadow-md hover:-translate-y-0.5 transition-all duration-200 rounded-xl p-3 text-sm text-gray-700 cursor-grab flex items-center gap-3 select-none" data-type="percent">
                                        <div class="w-8 h-8 rounded-lg bg-green-50 text-green-500 flex items-center justify-center"><i class="ri-percent-line text-lg"></i></div> 
                                        <span class="font-medium">Percent</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Date & Time -->
                            <div>
                                <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2 px-1">Date & Time</div>
                                <div class="space-y-2">
                                    <div class="palette-item bg-white shadow-sm border border-gray-200/50 hover:border-blue-400 hover:shadow-md hover:-translate-y-0.5 transition-all duration-200 rounded-xl p-3 text-sm text-gray-700 cursor-grab flex items-center gap-3 select-none" data-type="date">
                                        <div class="w-8 h-8 rounded-lg bg-orange-50 text-orange-500 flex items-center justify-center"><i class="ri-calendar-line text-lg"></i></div> 
                                        <span class="font-medium">Date</span>
                                    </div>
                                    <div class="palette-item bg-white shadow-sm border border-gray-200/50 hover:border-blue-400 hover:shadow-md hover:-translate-y-0.5 transition-all duration-200 rounded-xl p-3 text-sm text-gray-700 cursor-grab flex items-center gap-3 select-none" data-type="datetime">
                                        <div class="w-8 h-8 rounded-lg bg-orange-50 text-orange-500 flex items-center justify-center"><i class="ri-calendar-check-line text-lg"></i></div> 
                                        <span class="font-medium">Date/Time</span>
                                    </div>
                                    <div class="palette-item bg-white shadow-sm border border-gray-200/50 hover:border-blue-400 hover:shadow-md hover:-translate-y-0.5 transition-all duration-200 rounded-xl p-3 text-sm text-gray-700 cursor-grab flex items-center gap-3 select-none" data-type="time">
                                        <div class="w-8 h-8 rounded-lg bg-orange-50 text-orange-500 flex items-center justify-center"><i class="ri-time-line text-lg"></i></div> 
                                        <span class="font-medium">Time</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Logic & Choice -->
                            <div>
                                <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2 px-1">Logic & Choice</div>
                                <div class="space-y-2">
                                    <div class="palette-item bg-white shadow-sm border border-gray-200/50 hover:border-blue-400 hover:shadow-md hover:-translate-y-0.5 transition-all duration-200 rounded-xl p-3 text-sm text-gray-700 cursor-grab flex items-center gap-3 select-none" data-type="boolean">
                                        <div class="w-8 h-8 rounded-lg bg-purple-50 text-purple-500 flex items-center justify-center"><i class="ri-checkbox-line text-lg"></i></div> 
                                        <span class="font-medium">Checkbox</span>
                                    </div>
                                    <div class="palette-item bg-white shadow-sm border border-gray-200/50 hover:border-blue-400 hover:shadow-md hover:-translate-y-0.5 transition-all duration-200 rounded-xl p-3 text-sm text-gray-700 cursor-grab flex items-center gap-3 select-none" data-type="select">
                                        <div class="w-8 h-8 rounded-lg bg-purple-50 text-purple-500 flex items-center justify-center"><i class="ri-list-check text-lg"></i></div> 
                                        <span class="font-medium">Select</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Relationships -->
                            <div>
                                <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2 px-1">Relationships</div>
                                <div class="space-y-2">
                                    <div class="palette-item bg-white shadow-sm border border-gray-200/50 hover:border-blue-400 hover:shadow-md hover:-translate-y-0.5 transition-all duration-200 rounded-xl p-3 text-sm text-gray-700 cursor-grab flex items-center gap-3 select-none" data-type="lookup">
                                        <div class="w-8 h-8 rounded-lg bg-indigo-50 text-indigo-500 flex items-center justify-center"><i class="ri-search-line text-lg"></i></div> 
                                        <span class="font-medium">Lookup</span>
                                    </div>
                                    <div class="palette-item bg-white shadow-sm border border-gray-200/50 hover:border-blue-400 hover:shadow-md hover:-translate-y-0.5 transition-all duration-200 rounded-xl p-3 text-sm text-gray-700 cursor-grab flex items-center gap-3 select-none" data-type="master_detail">
                                        <div class="w-8 h-8 rounded-lg bg-indigo-50 text-indigo-500 flex items-center justify-center"><i class="ri-links-line text-lg"></i></div> 
                                        <span class="font-medium">Master-Detail</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Advanced & Layout -->
                            <div>
                                <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2 px-1">Advanced & Layout</div>
                                <div class="space-y-2">
                                    <div class="palette-item bg-white shadow-sm border border-gray-200/50 hover:border-blue-400 hover:shadow-md hover:-translate-y-0.5 transition-all duration-200 rounded-xl p-3 text-sm text-gray-700 cursor-grab flex items-center gap-3 select-none" data-type="formula">
                                        <div class="w-8 h-8 rounded-lg bg-gray-100 text-gray-600 flex items-center justify-center"><i class="ri-functions text-lg"></i></div> 
                                        <span class="font-medium">Formula</span>
                                    </div>
                                    <div class="palette-item bg-white shadow-sm border border-gray-200/50 hover:border-blue-400 hover:shadow-md hover:-translate-y-0.5 transition-all duration-200 rounded-xl p-3 text-sm text-gray-700 cursor-grab flex items-center gap-3 select-none" data-type="summary">
                                        <div class="w-8 h-8 rounded-lg bg-gray-100 text-gray-600 flex items-center justify-center"><i class="ri-calculator-line text-lg"></i></div> 
                                        <span class="font-medium">Roll-Up Summary</span>
                                    </div>
                                    <div class="palette-item bg-white shadow-sm border border-gray-200/50 hover:border-blue-400 hover:shadow-md hover:-translate-y-0.5 transition-all duration-200 rounded-xl p-3 text-sm text-gray-700 cursor-grab flex items-center gap-3 select-none" data-type="autonumber">
                                        <div class="w-8 h-8 rounded-lg bg-gray-100 text-gray-600 flex items-center justify-center"><i class="ri-list-ordered text-lg"></i></div> 
                                        <span class="font-medium">Auto Number</span>
                                    </div>
                                    <div class="palette-item bg-gray-50/80 shadow-sm border border-gray-200/50 hover:border-gray-400 hover:shadow-md hover:-translate-y-0.5 transition-all duration-200 rounded-xl p-3 text-sm font-semibold text-gray-700 cursor-grab flex items-center gap-3 select-none" data-type="section">
                                        <div class="w-8 h-8 rounded-lg bg-gray-200 text-gray-600 flex items-center justify-center"><i class="ri-layout-row-line text-lg"></i></div> 
                                        <span class="font-medium">Section</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Canvas Area -->
                    <div class="flex-1 relative flex flex-col overflow-hidden bg-grid-pattern">
                        <div id="designerCanvas" class="w-full h-full flex flex-col relative">
                            <!-- Header -->
                            <div id="canvasHeader" class="shrink-0 bg-white/80 backdrop-blur-md border-b border-gray-200/50 px-8 py-4 flex items-center gap-4 z-10">
                                <!-- Header content generated dynamically -->
                                <div class="w-10 h-10 rounded-lg bg-gray-100 animate-pulse"></div>
                                <div class="space-y-1.5">
                                    <div class="h-5 w-32 bg-gray-100 rounded animate-pulse"></div>
                                    <div class="h-3 w-20 bg-gray-50 rounded animate-pulse"></div>
                                </div>
                            </div>
                            
                            <!-- Drop Zone -->
                            <div id="formFieldsContainer" class="flex-1 overflow-y-auto bg-gray-50/50">
                                <div id="formFields" class="max-w-4xl mx-auto p-8 min-h-full grid grid-cols-2 gap-x-8 gap-y-6 content-start">
                                    <!-- Fields go here -->
                                    <div class="col-span-2 flex flex-col items-center justify-center py-20 text-gray-400 gap-4 border-2 border-dashed border-gray-200 rounded-xl m-4 bg-white/50">
                                        <i class="ri-add-circle-line text-4xl"></i>
                                        <span>Drag fields here to start designing</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Actions Footer -->
                            <div class="shrink-0 p-4 border-t border-gray-200/50 flex justify-end gap-3 bg-white/80 backdrop-blur-md z-10">
                                <div class="h-9 w-24 bg-gray-200 rounded-lg opacity-40"></div>
                                <div class="h-9 w-24 bg-blue-100 rounded-lg opacity-40"></div>
                            </div>
                        </div>
                    </div>
                 </div>
             </div>
        </div>

        <!-- AI Chat Sidebar -->
        <div id="aiChatSidebar" class="w-80 md:w-96 bg-[#1c1c1e] border-l border-white/10 flex-col transition-all duration-300 flex">
            <div class="p-4 border-b border-white/10 bg-[#2c2c2e] flex justify-between items-center">
                <h3 class="font-bold text-white flex items-center gap-2">
                    <span class="text-xl">âœ¨</span> AI Object Designer
                </h3>
            </div>
            
            <div id="aiChatMessages" class="flex-1 overflow-y-auto p-4 space-y-4">
                <div class="flex gap-3">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-purple-600 to-blue-600 flex items-center justify-center text-xs flex-shrink-0">AI</div>
                    <div class="bg-white/10 rounded-2xl rounded-tl-none px-4 py-2 text-sm text-gray-200">
                        Hi! describe the data object you want to build. I will generate the Steedos Object YAML for you.
                    </div>
                </div>
            </div>
            
            <div class="p-4 border-t border-white/10 bg-[#2c2c2e]">
                <div class="mb-3">
                    <div class="relative">
                        <select id="aiModelSelect" class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:border-purple-500 focus:ring-1 focus:ring-purple-500 focus:outline-none transition-colors appearance-none cursor-pointer hover:bg-white/5 disabled:opacity-50 disabled:cursor-not-allowed">
                            <option value="gpt-4o">Loading models...</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
                            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                        </div>
                    </div>
                </div>
                <div class="relative">
                    <textarea id="aiChatInput" rows="1" class="w-full bg-black/20 border border-white/10 rounded-xl pl-4 pr-10 py-3 text-white focus:border-purple-500 focus:ring-1 focus:ring-purple-500 focus:outline-none transition-colors resize-none text-sm" placeholder="Describe your object..."></textarea>
                    <button id="aiChatSend" class="absolute right-2 top-2 p-1.5 text-purple-500 hover:text-purple-400 transition-colors rounded-lg hover:bg-white/5">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Properties Panel (Right Sidebar) -->
        <div id="propertiesPanel" class="w-80 md:w-96 bg-white border-l border-gray-200 flex-col transition-all duration-300 hidden">
            <div class="p-4 border-b border-gray-200 bg-gray-50/50 backdrop-blur-sm flex justify-between items-center">
                <h3 class="font-semibold text-gray-800 flex items-center gap-2">
                    <i class="ri-settings-3-line"></i> Properties
                </h3>
                <button onclick="closePropertiesPanel()" class="p-1.5 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                    <i class="ri-close-line text-lg"></i>
                </button>
            </div>
            <div id="propertiesContent" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6">
                <!-- Content injected dynamically -->
            </div>
        </div>
    </div>

    <!-- 3rd Party Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    
    <!-- Centralized Field Type Definitions -->
    <script src="/js/field-types.js"></script>

    <script>
        const isNew = {{ isNew | default: false }};
        const objectId = "{{ object._id }}";
        const projectId = "{{ projectId }}";
        const initialSchema = {{ object.schema | json | default: "''" }};

        let editor;

        // 3. View Switcher Logic
        const viewBtnDesign = document.getElementById('viewBtnDesign');
        const viewBtnCode = document.getElementById('viewBtnCode');
        const codeView = document.getElementById('codeView');
        const designView = document.getElementById('designView');

        function switchView(view) {
            if (view === 'design') {
                codeView.classList.add('hidden');
                codeView.classList.remove('flex');
                designView.classList.remove('hidden');
                
                viewBtnDesign.classList.remove('text-gray-400', 'bg-transparent');
                viewBtnDesign.classList.add('bg-white/10', 'text-white', 'shadow-sm');
                
                viewBtnCode.classList.add('text-gray-400', 'bg-transparent');
                viewBtnCode.classList.remove('bg-white/10', 'text-white', 'shadow-sm');
                
                // Refresh designer from code
                updatePreview();
            } else {
                designView.classList.add('hidden');
                codeView.classList.remove('hidden');
                codeView.classList.add('flex'); // codeView needs flex for monaco to fill
                
                viewBtnCode.classList.remove('text-gray-400', 'bg-transparent');
                viewBtnCode.classList.add('bg-white/10', 'text-white', 'shadow-sm');
                
                viewBtnDesign.classList.add('text-gray-400', 'bg-transparent');
                viewBtnDesign.classList.remove('bg-white/10', 'text-white', 'shadow-sm');
                
                // Refresh editor layout
                if (editor) editor.layout();
            }
        }

        viewBtnDesign.addEventListener('click', () => switchView('design'));
        viewBtnCode.addEventListener('click', () => switchView('code'));

        // 1. Initialize Monaco Editor
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' }});
        
        require(['vs/editor/editor.main'], function() {
            let defaultValue = initialSchema;
            
            if (isNew && (!defaultValue || defaultValue === "''")) {
                const randomName = 'obj_' + Math.random().toString(36).substr(2, 6);
                const defaultYaml = {
                    name: randomName,
                    label: "New Object",
                    icon: "box",
                    version: "1.0.0",
                    description: "A new object definition",
                    fields: {
                        name: {
                            type: "text",
                            label: "Name",
                            required: true,
                            searchable: true
                        }
                    }
                };
                defaultValue = jsyaml.dump(defaultYaml);
            } else if (!defaultValue) {
                defaultValue = '# Describe your object in AI chat, or type YAML here...';
            }

            editor = monaco.editor.create(document.getElementById('editor-container'), {
                value: defaultValue,
                language: 'yaml',
                theme: 'vs-dark',
                automaticLayout: true,
                minimap: { enabled: false },
                fontSize: 14,
                padding: { top: 20 }
            });

            // Listen for changes
            editor.onDidChangeModelContent(() => {
                updateSaveButtonState();
                // If design view is active, update it
                if (!designView.classList.contains('hidden')) {
                     if (window.previewTimeout) clearTimeout(window.previewTimeout);
                     window.previewTimeout = setTimeout(updatePreview, 500);
                }
            });

            updateSaveButtonState();
            setTimeout(updatePreview, 500); // Initial load
            initDragAndDrop(); // Init Palette DnD
            initPaletteClick(); // Click to add support
        });

        // 2. Preview & Designer Logic
        let sortableCanvas = null;

        function updatePreview() {
            const schema = editor.getValue();
            const header = document.getElementById('canvasHeader');
            const fieldsContainer = document.getElementById('formFields');

            try {
                const obj = jsyaml.load(schema);
                
                if (!obj) {
                    // renderEmpty(doc, 'Start typing to see preview...');
                    return;
                }

                // Render Header
                renderHeader(header, obj);
                
                // Render Fields
                renderFields(fieldsContainer, obj);

                 // Re-init Sortable on the new list
                 initCanvasSortable();

            } catch (e) {
                // Should show error in designer area
                console.error(e);
            }
        }

        function renderHeader(container, obj) {
             const label = obj.label || obj.name || 'Untitled Object';
             // const icon = obj.icon || 'cube'; // Steedos icon names might not match Remix directly
             
             container.innerHTML = `
                <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center text-white shadow-lg shadow-blue-500/20 ring-1 ring-white/20">
                    <i class="ri-database-2-line text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-900 tracking-tight leading-tight">${label}</h1>
                    <div class="flex items-center gap-2 text-sm font-medium text-gray-500">
                        <span>New Record</span>
                        <span class="w-1 h-1 rounded-full bg-gray-300"></span>
                        <span class="text-xs text-gray-400 font-normal uppercase tracking-wide">Standard Layout</span>
                    </div>
                </div>
             `;
        }

        function renderFields(container, obj) {
            const fields = obj.fields || {};
            let html = '';
            
            // Convert to array to preserve order if YAML parser respects it (js-yaml usually does for objects)
            // But to be Sortable compliant, we need data attributes on elements to map back to field names
            const fieldKeys = Object.keys(fields);
            
            if (fieldKeys.length === 0) {
                 container.innerHTML = `
                    <div class="col-span-2 flex flex-col items-center justify-center py-20 text-gray-300 gap-4 border-2 border-dashed border-gray-100 rounded-xl m-4">
                        <i class="ri-add-circle-line text-4xl"></i>
                        <span>Drag fields here to start designing</span>
                    </div>`;
                 return;
            }

            fieldKeys.forEach(key => {
                const field = fields[key];
                html += generateDesignerFieldHtml(key, field);
            });

            container.innerHTML = html;
        }

        function generateDesignerFieldHtml(key, field) {
            const label = field.label || key;
            const required = field.required ? '<span class="text-red-500">*</span>' : '';
            
            // Get definition from registry
            const def = getFieldType(field.type);
            
            // Wide fields
            const isWide = field.is_wide || def.isWide || ['section'].includes(field.type);
            const colSpanClass = isWide ? 'col-span-2' : 'col-span-1';

            // Check selection state
            const isSelected = (typeof currentSelectedFieldKey !== 'undefined') && (key === currentSelectedFieldKey);
            const activeClass = isSelected ? 'ring-2 ring-blue-500 bg-blue-50/50 shadow-[0_0_0_4px_rgba(59,130,246,0.1)]' : '';

            // Section Rendering
            if (field.type === 'section') {
                return `
                <div class="${colSpanClass} p-4 rounded-xl hover:bg-white hover:shadow-md group border border-transparent hover:border-blue-100 cursor-move transition-all duration-200 relative mt-4 group ${activeClass}" data-id="${key}" onclick="selectField(event, '${key}')">
                    <div class="flex justify-between items-end border-b-2 border-gray-100 pb-2">
                        <h3 class="text-xl font-bold text-gray-800 tracking-tight">${label}</h3>
                         <button class="opacity-0 group-hover:opacity-100 p-1.5 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all" title="Delete" onclick="event.stopPropagation(); deleteField('${key}')">
                            <i class="ri-delete-bin-line text-sm"></i>
                        </button>
                    </div>
                </div>
                `;
            }
           
            // Render Input HTML via Registry
            let inputHtml = '';
            if (field.readonly) {
                 // Use base readonly render or custom if needed
                 inputHtml = FieldTypes.base.renderReadOnly(field);
            } else if (def && def.renderInput) {
                inputHtml = def.renderInput(field);
            } else {
                // Fallback
                inputHtml = FieldTypes.base.renderInput(field);
            }

            return `
                <div class="${colSpanClass} field-item p-3 -mx-3 rounded-xl hover:bg-blue-50/30 group border border-transparent hover:border-blue-200/30 cursor-move transition-all duration-200 relative ${activeClass}" data-id="${key}" onclick="selectField(event, '${key}')">
                    <div class="mb-1.5 flex justify-between items-center px-0.5">
                        <label class="block text-sm font-medium text-gray-600 tracking-tight flex items-center gap-1">
                            ${label} ${required}
                        </label>
                         <button class="opacity-0 group-hover:opacity-100 p-1 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded transition-all" title="Delete" onclick="event.stopPropagation(); deleteField('${key}')">
                            <i class="ri-close-line text-sm"></i>
                        </button>
                    </div>
                    ${inputHtml}
                </div>
            `;
        }
        
        // Initial DnD setup
        let sortablePalettes = [];
        function initDragAndDrop() {
            const palette = document.getElementById('fieldsPalette');
            if (palette) {
                // Cleanup old instances
                if (sortablePalettes.length > 0) {
                    sortablePalettes.forEach(s => s.destroy());
                    sortablePalettes = [];
                }

                // Initialize for each group of items
                // The structure is Category -> Space-y-2 Container -> Items
                const itemContainers = palette.querySelectorAll('.space-y-2');
                
                itemContainers.forEach(container => {
                    const sortable = new Sortable(container, {
                        group: {
                            name: 'fields',
                            pull: 'clone',
                            put: false 
                        },
                        sort: false, // Palette is not sortable
                        animation: 150,
                        draggable: '.palette-item'
                    });
                    sortablePalettes.push(sortable);
                });
            }
        }

        function initCanvasSortable() {
             const formFields = document.getElementById('formFields');
             if (!formFields) return;

             // Destroy old instance if exists to avoid dupes
             if (sortableCanvas) sortableCanvas.destroy();

             sortableCanvas = new Sortable(formFields, {
                group: 'fields',
                animation: 150,
                ghostClass: 'bg-blue-100',
                onAdd: function (evt) {
                    const item = evt.item; // The dragged element
                    const type = item.getAttribute('data-type');
                    
                    // Generate new field name
                    const fieldName = generateFieldName(type);
                    
                    // Remove the dragged DOM element immediately, we will regenerate from YAML
                    item.remove();
                    
                    // Add to YAML
                    addFieldToYaml(fieldName, type, evt.newIndex);
                },
                onSort: function (evt) {
                     // Check if it's a reorder within the list (not an add)
                     if (evt.from === evt.to && evt.oldIndex !== evt.newIndex) {
                         reorderFieldsInYaml(evt.oldIndex, evt.newIndex);
                     }
                }
            });
        }

        function generateFieldName(type) {
            // Simple random or existing check could be added
            return type + '_' + Math.random().toString(36).substr(2, 5);
        }

        function addFieldToYaml(name, type, index) {
            const schema = editor.getValue();
            try {
                let obj = jsyaml.load(schema) || {};
                if (!obj.fields) obj.fields = {};
                
                // Create new field object
                const newField = {
                    label: name.charAt(0).toUpperCase() + name.slice(1).split('_')[0],
                    type: type
                };
                
                // Need to insert at specific index.
                // Objects in JS/YAML are unordered by spec, but implementation often respects insertion order.
                // We'll reconstruct the fields object.
                const entries = Object.entries(obj.fields);
                entries.splice(index, 0, [name, newField]);
                
                const newFields = {};
                entries.forEach(([k, v]) => newFields[k] = v);
                obj.fields = newFields;

                // Dump
                const newYaml = jsyaml.dump(obj);
                editor.setValue(newYaml);
                // Preview will auto update via listener
            } catch (e) {
                console.error(e);
            }
        }

        function initPaletteClick() {
            const palette = document.getElementById('fieldsPalette');
            if (!palette) return;

            palette.addEventListener('click', function(e) {
                const item = e.target.closest('.palette-item');
                if (item) {
                   const type = item.getAttribute('data-type');
                   if(type) handleAddFieldClick(type);
                }
            });
        }

        function handleAddFieldClick(type) {
             const schema = editor.getValue();
             let obj = {};
             try {
                obj = jsyaml.load(schema) || {};
             } catch (e) { console.error(e); }
             
             if (!obj.fields) obj.fields = {};
             const keys = Object.keys(obj.fields);
             
             let insertIndex = keys.length; // Default to end
             
             // If a field is currently selected, insert after it
             if (currentSelectedFieldKey && obj.fields[currentSelectedFieldKey]) {
                 const currentIndex = keys.indexOf(currentSelectedFieldKey);
                 if (currentIndex !== -1) {
                     insertIndex = currentIndex + 1;
                 }
             }

             const fieldName = generateFieldName(type);
             
             // Set selection to new field so it gets highlighted on refresh
             currentSelectedFieldKey = fieldName;
             
             addFieldToYaml(fieldName, type, insertIndex);
        }

        function reorderFieldsInYaml(oldIndex, newIndex) {
            const schema = editor.getValue();
            try {
                let obj = jsyaml.load(schema) || {};
                if (!obj.fields) return;

                const entries = Object.entries(obj.fields);
                const [moved] = entries.splice(oldIndex, 1);
                entries.splice(newIndex, 0, moved);

                const newFields = {};
                entries.forEach(([k, v]) => newFields[k] = v);
                obj.fields = newFields;

                const newYaml = jsyaml.dump(obj);
                editor.setValue(newYaml);
            } catch(e) { console.error(e); }
        }

        window.deleteField = function(key) {
             const schema = editor.getValue();
             try {
                let obj = jsyaml.load(schema) || {};
                if (obj.fields && obj.fields[key]) {
                    delete obj.fields[key];
                    const newYaml = jsyaml.dump(obj);
                    editor.setValue(newYaml);
                }
             } catch(e) { console.error(e); }
        };

        // 2. Save Logic
        function updateSaveButtonState() {
             // Basic state management
        }

        async function saveObject() {
            const schema = editor.getValue().trim();
            if (!schema) {
                $notify('Please enter or generate a schema first', 'warning');
                return;
            }

            // Simple parsing to extract name and label
            const nameMatch = schema.match(/^name:\s*(.+)$/m);
            const labelMatch = schema.match(/^label:\s*(.+)$/m);
            const descriptionMatch = schema.match(/^description:\s*(.+)$/m);

            const data = {
                projectId: projectId,
                schema: schema,
                name: nameMatch ? nameMatch[1].trim() : (isNew ? 'untitled' : '{{ object.name }}'),
                label: labelMatch ? labelMatch[1].trim() : (isNew ? 'Untitled' : '{{ object.label }}'),
                description: descriptionMatch ? descriptionMatch[1].trim() : '',
                icon: 'cube'
            };

            try {
                const url = isNew ? `/app/${projectId}/objects` : `/app/${projectId}/objects/${objectId}`;
                const method = isNew ? 'POST' : 'PUT';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Failed to save');

                const savedObj = await response.json();
                
                showStatus('Object saved successfully!', 'success');
                
                if (isNew) {
                     setTimeout(() => {
                        window.location.href = `/app/${projectId}/objects/${savedObj._id}`;
                    }, 500);
                }
            } catch (error) {
                console.error(error);
                showStatus('Failed to save object.', 'error');
            }
        }

        function showStatus(msg, type) {
            $notify(msg, type);
        }

        function copyToClipboard() {
            const val = editor.getValue();
            navigator.clipboard.writeText(val).then(() => {
                const btn = document.querySelector('button[onclick="copyToClipboard()"]');
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }
        
        // 3. AI Chat Logic (Copied and adapted from Page Editor)
        const aiChatInput = document.getElementById('aiChatInput');
        const aiChatSend = document.getElementById('aiChatSend');
        const aiChatMessages = document.getElementById('aiChatMessages');

        // Field Properties Logic
        let currentSelectedFieldKey = null;
        const aiChatSidebar = document.getElementById('aiChatSidebar');
        const propertiesPanel = document.getElementById('propertiesPanel');
        const propertiesContent = document.getElementById('propertiesContent');

        function selectField(event, key) {
            if (event) event.stopPropagation(); // Avoid triggering container clicks if any
            
            // Visual feedback
            document.querySelectorAll('[data-id]').forEach(el => {
                el.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50/50', 'shadow-[0_0_0_4px_rgba(59,130,246,0.1)]');
            });
            const selectedEl = document.querySelector(`[data-id="${key}"]`);
            if (selectedEl) {
                selectedEl.classList.add('ring-2', 'ring-blue-500', 'bg-blue-50/50', 'shadow-[0_0_0_4px_rgba(59,130,246,0.1)]');
            }

            // Show Panel
            currentSelectedFieldKey = key;
            if (aiChatSidebar) aiChatSidebar.classList.add('hidden');
            if (aiChatSidebar) aiChatSidebar.classList.remove('flex');
            if (propertiesPanel) propertiesPanel.classList.remove('hidden');
            if (propertiesPanel) propertiesPanel.classList.add('flex');

            renderPropertiesPanel(key);
        }

        function closePropertiesPanel() {
            currentSelectedFieldKey = null;
            // Clear selection visual
             document.querySelectorAll('[data-id]').forEach(el => {
                el.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50/50', 'shadow-[0_0_0_4px_rgba(59,130,246,0.1)]');
            });

            if (propertiesPanel) propertiesPanel.classList.add('hidden');
            if (propertiesPanel) propertiesPanel.classList.remove('flex');
            
            // Show AI again ? Or just leave generic empty ? 
             if (aiChatSidebar) aiChatSidebar.classList.remove('hidden');
            if (aiChatSidebar) aiChatSidebar.classList.add('flex');
        }

        function renderPropertiesPanel(key) {
            // console.log('Rendering properties for:', key);
            const schema = editor.getValue();
            let obj = {};
            try {
                obj = jsyaml.load(schema) || {};
            } catch (e) {
                console.error('YAML load error:', e);
                propertiesContent.innerHTML = '<p class="text-red-500 text-center p-4">Error parsing YAML</p>';
                return;
            }

            const fields = obj.fields || {};
            let field = fields[key];

            if (!field) {
                propertiesContent.innerHTML = '<p class="text-gray-400 text-center p-4">Field not found</p>';
                return;
            }
            if (typeof field !== 'object') field = {};

            // Get definition
            const def = getFieldType(field.type);
            const baseProps = FieldTypes.base.properties;
            const customProps = def.properties || [];
            
            // To ensure correct order and no duplicates, we can merge or concat
            // But typically, base props like name/label/type go first
            // followed by custom props, then base common properties like required/hidden/desc
            
            // Re-implement renderer using the config list
            
            const escapeAttr = (str) => {
                if (str === undefined || str === null) return '';
                return String(str).replace(/"/g, '&quot;');
            };
            
            // Helpers
            const createInput = (p, val) => {
                const safeValue = escapeAttr(val);
                const ro = p.readonly ? 'readonly' : '';
                return `
                    <div class="space-y-1.5">
                        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider">${p.label}</label>
                        <input type="${p.inputType || 'text'}" 
                            class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all placeholder:text-gray-300"
                            value="${safeValue}"
                            onchange="updateFieldProperty('${key}', '${p.name}', this.value)"
                            ${ro}
                        >
                    </div>`;
            };
            
            const createTextarea = (p, val) => {
                 // If val is an object/array (like options), dump it to YAML/string for editing
                 let displayVal = val;
                 if (typeof val === 'object' && val !== null) {
                     displayVal = jsyaml.dump(val).trim();
                 }
                 
                 const safeText = String(displayVal || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                 return `
                    <div class="space-y-1.5">
                        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider">${p.label}</label>
                        <textarea 
                            rows="${p.rows || 3}"
                            class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all placeholder:text-gray-300 resize-none font-mono"
                            onchange="updateFieldProperty('${key}', '${p.name}', this.value)"
                        >${safeText}</textarea>
                    </div>`;
            };
            
             const createCheckbox = (p, checked) => {
                return `
                    <div class="flex items-center justify-between py-1">
                        <label class="text-sm font-medium text-gray-700">${p.label}</label>
                         <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer" ${checked ? 'checked' : ''} onchange="updateFieldProperty('${key}', '${p.name}', this.checked)">
                            <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>`;
            };
            
             const createSelect = (p, val) => {
                // If options is string (function name) or array
                let opts = p.options;
                if (typeof opts === 'string') {
                    // Try to evaluate function in global scope (dangerous but simple for this script)
                    if (window[opts] && typeof window[opts] === 'function') {
                        opts = window[opts]();
                    } else {
                        opts = [];
                    }
                }
                
                return `
                    <div class="space-y-1.5">
                        <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider">${p.label}</label>
                         <div class="relative">
                            <select 
                                class="w-full pl-3 pr-8 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all appearance-none cursor-pointer"
                                onchange="updateFieldProperty('${key}', '${p.name}', this.value)"
                            >
                                ${opts.map(o => `<option value="${o.value}" ${o.value === val ? 'selected' : ''}>${o.label}</option>`).join('')}
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
                                <i class="ri-arrow-down-s-line"></i>
                            </div>
                        </div>
                    </div>`;
            };

            // Build Property List
            // 1. Identity (Name, Label, Type)
            // 2. Custom Properties (e.g. scale, reference_to)
            // 3. Flags (Required, Searchable, etc)
            // 4. Content (Description, Help Text, Default Value)
            
            const renderPropsGroup = (props) => {
                 return props.map(p => {
                     // Check visibility overrides ? (not implemented yet)
                     const val = (p.name === 'name_key') ? key : field[p.name]; 
                     // defaultValue from config if val is undefined ?
                     const currentVal = (val === undefined && p.defaultValue !== undefined && !field.hasOwnProperty(p.name)) ? p.defaultValue : val;

                     if (p.type === 'text' || p.type === 'number') return createInput(p, currentVal);
                     if (p.type === 'textarea') return createTextarea(p, currentVal);
                     if (p.type === 'boolean') return createCheckbox(p, currentVal);
                     if (p.type === 'select') return createSelect(p, currentVal);
                     return '';
                 }).join('');
            };
            
            // Extract standard props from base
            const allBase = FieldTypes.base.properties;
            const groupIdentity = allBase.slice(0, 3); // name, label, type
            const groupFlags = allBase.slice(4, 8); // required, readonly, hidden, searchable
            const groupContent = allBase.slice(8); // description, help
            
            let html = `<div class="space-y-4">${renderPropsGroup(groupIdentity)}</div>`;
            
            if (customProps.length > 0) {
                 html += `<hr class="border-gray-100"><div class="space-y-4">${renderPropsGroup(customProps)}</div>`;
            }
            
            html += `<hr class="border-gray-100"><div class="space-y-2">${renderPropsGroup(groupFlags)}</div>`;
            
            // Default Value is tricky, it's in base but often custom position. Let's put it with content
            html += `<hr class="border-gray-100"><div class="space-y-4">
                ${createInput({name:'defaultValue', label:'Default Value', type:'text'}, field.defaultValue)}
                ${renderPropsGroup(groupContent)}
            </div>`;

            propertiesContent.innerHTML = html;
        }

        function updateFieldProperty(key, prop, value) {
            const schema = editor.getValue();
            try {
                let obj = jsyaml.load(schema) || {};
                if (!obj.fields || !obj.fields[key]) return;

                // Handle Key Change (Rename)
                if (prop === 'name_key') {
                    if (value === key) return; // No change
                    if (obj.fields[value]) {
                        alert('Field Name must be unique!');
                        return;
                    }
                    
                    // Rename logic: recreate fields object maintaining order
                    const newFields = {};
                    for (const k in obj.fields) {
                        if (k === key) {
                            newFields[value] = obj.fields[key];
                        } else {
                            newFields[k] = obj.fields[k];
                        }
                    }
                    obj.fields = newFields;
                    
                    // Update global tracking
                    currentSelectedFieldKey = value;
                    key = value; // update local var for subsequent calls if any, though function will exit and re-render expected
                    
                    // We need to re-render the panel because the attribute 'key' in input onchange handlers is now stale
                    // But dumping yaml effectively refreshes everything if we update editor
                } 
                else {
                    // Normal Property Update
                     if (prop === 'options' && typeof value === 'string') {
                         // Try to parse as YAML/JSON
                         try {
                              // If it looks like YAML/JSON (has newlines or brackets), try to parse
                              // Use safeLoad from js-yaml
                              const parsed = jsyaml.load(value);
                              // Only use parsed if it's an array or object, otherwise keep string
                              if (typeof parsed === 'object' && parsed !== null) {
                                  value = parsed;
                              }
                         } catch (e) {
                             // If parse fails, treat as multiline string split? 
                             // Or just leave as string if Steedos supports it.
                             // Steedos supports simple strings for options too.
                             // But if user intended structure and failed, maybe we should warn? 
                             // For now, let's just leave logic simple: try parse, if valid object, use it.
                         }
                     }
                    
                    obj.fields[key][prop] = value;
                }

                // Dump
                const newYaml = jsyaml.dump(obj);
                editor.setValue(newYaml);
                
                // If we renamed, we must refresh the properties panel so inputs trigger on new Key
                if (prop === 'name_key') {
                    renderPropertiesPanel(currentSelectedFieldKey);
                    // Update selection visual is handled by updatePreview -> renderFields -> but we need to re-apply selection
                    // Because renderFields completely wipes DOM
                    setTimeout(() => {
                         const newEl = document.querySelector(`[data-id="${currentSelectedFieldKey}"]`);
                         if (newEl) newEl.click();
                    }, 100);
                }

            } catch (e) {
                console.error(e);
            }
        }


        function addMessage(role, text) {
            const div = document.createElement('div');
            div.className = 'flex gap-3 ' + (role === 'user' ? 'flex-row-reverse' : '');
            
            const avatar = role === 'user' 
                ? `<div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center text-xs flex-shrink-0">You</div>`
                : `<div class="w-8 h-8 rounded-full bg-gradient-to-tr from-purple-600 to-blue-600 flex items-center justify-center text-xs flex-shrink-0">AI</div>`;
            
            const bubble = `<div class="${role === 'user' ? 'bg-blue-600 text-white' : 'bg-white/10 text-gray-200'} rounded-2xl ${role === 'user' ? 'rounded-tr-none' : 'rounded-tl-none'} px-4 py-2 text-sm whitespace-pre-wrap">${text}</div>`;
            
            div.innerHTML = role === 'user' ? bubble + avatar : avatar + bubble;
            aiChatMessages.appendChild(div);
            aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
        }

        async function handleAiSend() {
            const prompt = aiChatInput.value.trim();
            if (!prompt) return;

            addMessage('user', prompt);
            aiChatInput.value = '';
            aiChatInput.style.height = 'auto';

            // Show loading
            const loadingId = 'ai-loading-' + Date.now();
            const loadingDiv = document.createElement('div');
            loadingDiv.id = loadingId;
            loadingDiv.className = 'flex gap-3';
            loadingDiv.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-purple-600 to-blue-600 flex items-center justify-center text-xs flex-shrink-0">AI</div>
                <div class="bg-white/10 rounded-2xl rounded-tl-none px-4 py-2 text-sm text-gray-200 flex items-center gap-2">
                    <span>Thinking</span>
                    <span class="animate-bounce">.</span><span class="animate-bounce delay-100">.</span><span class="animate-bounce delay-200">.</span>
                </div>
            `;
            aiChatMessages.appendChild(loadingDiv);
            aiChatMessages.scrollTop = aiChatMessages.scrollHeight;

            try {
                const currentCode = editor ? editor.getValue() : '';
                const model = document.getElementById('aiModelSelect').value;
                const response = await fetch('/api/ai/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, currentCode, model, type: 'object' })
                });

                const data = await response.json();
                document.getElementById(loadingId).remove();

                if (response.ok && data.code) {
                    addMessage('ai', 'I have updated the Object schema based on your request.');
                    editor.setValue(data.code);
                } else {
                    addMessage('ai', 'Sorry, something went wrong: ' + (data.message || 'Unknown error'));
                }
            } catch (e) {
                console.error(e);
                if (document.getElementById(loadingId)) document.getElementById(loadingId).remove();
                addMessage('ai', 'Sorry, I encountered a network error.');
            }
        }

        if (aiChatSend) aiChatSend.addEventListener('click', handleAiSend);
        if (aiChatInput) {
            aiChatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleAiSend();
                }
            });
            // Auto resize
            aiChatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
        }

        // Fetch and cache models (Same as Page Editor - reuse logic ideally)
        async function loadModels() {
            const modelSelect = document.getElementById('aiModelSelect');
            if (!modelSelect) return;

            const fallbackModels = [
                { id: 'gpt-4o' },
                { id: 'google/gemini-3-pro-preview' }
            ];

            try {
                const res = await fetch('/api/ai/models');
                if (res.ok) {
                    let models = await res.json();
                    // If backend returns empty array (e.g. no API key), use fallback
                    if (!models || !Array.isArray(models) || models.length === 0) {
                        models = fallbackModels;
                    }
                    renderModels(models);
                } else {
                     renderModels(fallbackModels);
                }
            } catch (e) { 
                console.error('Error loading models:', e); 
                renderModels(fallbackModels);
            }
        }

        function renderModels(models) {
            const modelSelect = document.getElementById('aiModelSelect');
            if (!modelSelect) return;
            modelSelect.innerHTML = models.map(m => `<option value="${m.id}">${m.id}</option>`).join('');
            const savedModel = localStorage.getItem('ai_selected_model');
            if (savedModel) modelSelect.value = savedModel;
            modelSelect.addEventListener('change', () => localStorage.setItem('ai_selected_model', modelSelect.value));
        }

        loadModels();

    </script>
</body>
</html>
